# serverless-fargate.yml
org: carlosalith
service: alerta-utec-fargate-backend

plugins:
  - serverless-fargate-plugin

provider:
  name: aws
  region: us-east-1
  # Mantén provider simple: no pongas aquí 'iam.taskRole' ni campos propios del plugin.

custom:
  # Todas las opciones específicas del plugin Fargate van dentro de custom.fargate
  fargate:
    # Cluster ECS
    cluster: alerta-utec-cluster

    # ALB (Application Load Balancer)
    alb:
      name: alerta-utec-alb
      securityGroups:
        - sg-0a1b5b40b49d1e6e0
      subnets:
        - subnet-07faeabfbd92cf773
        - subnet-043b0ddb38c8c44b4
        - subnet-0fb755b639e662042
        - subnet-0c52b65256305a50b
        - subnet-09ee1cd3fefabaa26
        - subnet-09cd3086124d184b4

    # Roles IAM (para la tarea y la ejecución) que ya creaste en la cuenta
    iam:
      taskRole: arn:aws:iam::263323339622:role/LabRole
      executionRole: arn:aws:iam::263323339622:role/LabRole

    # ECR (image build/push) config. 'dockerfile' aquí es manejado por el plugin.
    ecr:
      images:
        alerta-utec-backend:
          path: .
          dockerfile: Dockerfile

    # Servicio y TaskDefinition (tu app)
    service: alerta-utec-backend-service

    task:
      cpu: 512
      memory: 1024
      image: alerta-utec-backend
      port: 8080

      environment:
        PORT: 8080
        NODE_ENV: production
        AWS_REGION: us-east-1
        JWT_SECRET: "mi-secreto-para-la-hackathon-utec-2025-es-increible"
        DDB_TABLE_USUARIOS: AlertaUTEC_Usuarios
        DDB_TABLE_INCIDENTES: AlertaUTEC_Incidentes
        DDB_TABLE_HISTORIAL: AlertaUTEC_Historial
        DDB_TABLE_CONEXIONES_WS: AlertaUTEC_ConexionesWS
        WS_API_GATEWAY_URL: wss://ufs7epfg85.execute-api.us-east-1.amazonaws.com/dev
        WS_API_REGION: us-east-1
        AIRFLOW_API_URL: http://3.236.149.2:8081/api/v1

      vpc:
        id: vpc-01ca41df3938a43d0
        subnets:
          - subnet-07faeabfbd92cf773
          - subnet-043b0ddb38c8c44b4
          - subnet-0fb755b639e662042
          - subnet-0c52b65256305a50b
          - subnet-09ee1cd3fefabaa26
          - subnet-09cd3086124d184b4
        securityGroups:
          - sg-0a1b5b40b49d1e6e0

      alb:
        listener: 80
        containerPort: 8080
        path: /*

# No definas 'resources' ni 'fargate' en la raíz que sean específicos del plugin.
# El plugin leerá custom.fargate y generará los recursos necesarios en CloudFormation.
